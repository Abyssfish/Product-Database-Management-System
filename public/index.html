<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>商品价格查询</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .camera-container { text-align: center; margin-bottom: 20px; }
        #video { border: 2px solid #333; border-radius: 8px; }
        #canvas { display: none; }
        .button-group { margin: 10px 0; }
        button { padding: 10px 20px; margin: 0 5px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #45a049; }
        #result { margin-top: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .product-item { margin: 10px 0; padding: 10px; border-bottom: 1px solid #eee; }
        .platform { display: inline-block; padding: 3px 8px; background-color: #007bff; color: white; border-radius: 4px; font-size: 0.8em; margin-right: 10px; }
            /* 添加响应式样式 */
            @media (max-width: 768px) {
                #video-container {
                    width: 100%;
                    height: auto;
                    max-height: 60vh;
                }
                button {
                    padding: 12px 24px;
                    font-size: 16px;
                }
                #result {
                    font-size: 14px;
                }
            }
            .search-container {
                margin: 15px 0;
                display: flex;
                gap: 10px;
            }
            #keywordInput {
                flex: 1;
                padding: 10px;
                font-size: 16px;
                border: 1px solid #ddd;
                border-radius: 4px;
            }
    </style>
</head>
<body>
    <h1>商品价格查询</h1>
    <div class="camera-container">
        <video id="video" autoplay playsinline width="480" height="320"></video>
        <canvas id="canvas" width="480" height="320"></canvas>
        <div class="button-group">
            <button id="startBtn">开始摄像头</button>
            <button id="captureBtn">拍照识别</button>
            <button id="stopBtn">停止摄像头</button>
        </div>
    </div>
    <div id="result"></div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const startBtn = document.getElementById('startBtn');
        const captureBtn = document.getElementById('captureBtn');
        const stopBtn = document.getElementById('stopBtn');
        const resultDiv = document.getElementById('result');
        let stream = null;

        // 启动摄像头
        startBtn.addEventListener('click', async () => {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
            } catch (err) {
                resultDiv.innerHTML = `摄像头访问失败: ${err.message}`;
            }
        });

        // 停止摄像头
        stopBtn.addEventListener('click', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
        });

        // 拍照识别
        captureBtn.addEventListener('click', async () => {
            if (!stream) {
                resultDiv.innerHTML = '请先启动摄像头';
                return;
            }

            // 绘制视频帧到canvas
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = canvas.toDataURL('image/jpeg');

            try {
                resultDiv.innerHTML = '识别中...';
                // 发送图片到后端
                const response = await fetch('/api/ocr', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: imageData })
                });

                const data = await response.json();
                if (data.error) {
                    resultDiv.innerHTML = `错误: ${data.error}`;
                } else if (data.products && data.products.length > 0) {
                    displayResults(data.keyword, data.products);
                } else {
                    resultDiv.innerHTML = `未找到与 '${keyword}' 相关的商品，请尝试其他关键词或调整拍摄角度。`;
                }
            } catch (err) {
                resultDiv.innerHTML = `摄像头访问失败: ${err.message}`;
            }
        });
        // 启动摄像头
        async function startCamera() {
            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('您的浏览器不支持摄像头访问，请使用最新版浏览器或切换至HTTPS环境');
                }
                const constraints = {
                    video: {
                        width: { ideal: 480 },
                        height: { ideal: 640 },
                        facingMode: 'environment' // 默认使用后置摄像头
                    },
                    audio: false
                };
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                videoElement.srcObject = stream;
                isCameraActive = true;
            } catch (err) {
                console.error('摄像头访问失败:', err);
                resultDiv.innerHTML = `摄像头访问失败: ${err.message}<br>请确保已授予摄像头权限并尝试刷新页面`;
            }
        }
        // 拍照按钮事件监听
        captureButton.addEventListener('click', captureImage);
        captureButton.addEventListener('touchstart', (e) => {
            e.preventDefault();
            captureImage();
        });
        // 关键词搜索功能
        const searchButton = document.getElementById('searchButton');
        const keywordInput = document.getElementById('keywordInput');
        searchButton.addEventListener('click', searchByKeyword);
        keywordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchByKeyword();
            }
        });
        async function searchByKeyword() {
            const keyword = keywordInput.value.trim();
            if (!keyword) {
                resultDiv.innerHTML = '请输入搜索关键词';
                return;
            }
            try {
                resultDiv.innerHTML = '搜索中...';
                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keyword: keyword })
                });
                const data = await response.json();
                if (data.error) {
                    resultDiv.innerHTML = `错误: ${data.error}`;
                } else if (data.products && data.products.length > 0) {
                    displayResults(keyword, data.products);
                } else {
                    resultDiv.innerHTML = `未找到与 '${keyword}' 相关的商品`;
                }
            } catch (err) {
                resultDiv.innerHTML = `搜索失败: ${err.message}`;
            }
        }
    </script>
</body>
</html>